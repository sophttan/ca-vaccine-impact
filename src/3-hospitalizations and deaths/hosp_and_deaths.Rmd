---
title: "Hospitalizations and Deaths Analysis"
author: "Sophia Tan"
date: "1/12/2022"
output: html_document
---

```{r setup, include=FALSE}
#Loading in libraries
library(readr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(tibble)
library(lubridate)
library(scales)
library(stringr)
library(gridExtra)
library(patchwork)
library(knitr)

knitr::opts_chunk$set(echo = FALSE, message=F, warning=F)
knitr::opts_knit$set(root.dir = "/mnt/projects/covid_partners/ucsf_lo")
```

### Prepare hospitalization data from case registry

Includes only hospitalizations and deaths of confirmed cases and individuals with age data (calculated from DOB)

Below is the first few rows of case registry

```{r, echo = F, message=F}
dates <- read_csv("Direct Effects Analysis/Data/weeks_months_data.csv") %>% select(!X1)

#Loading in datasets
covid_data <- read_csv("Data/covid_registry_2021-10-17.csv") 

#Converting 'dtepisode' variable to Date objects
covid_data$dtepisode <- as.Date(covid_data$dtepisode)
covid_data$dtdeath <- as.Date(covid_data$dtdeath)

#Filtering only 'Confirmed' cases for 'cste_def' variable
covid_data_clean <- covid_data %>%
  filter(cste_def == 'Confirmed')

#Calculate weeks since January 2020
jan_1 <- as.Date("2020-01-01", format = "%Y-%m-%d")
covid_data_clean <- covid_data_clean %>%
  mutate(weeks_since_Jan2020 = round(as.vector(difftime(as.Date(dtepisode,format="%Y-%m-%d"),jan_1,units="weeks"))),
         months_since_Jan2020 = lubridate::interval(jan_1, as.Date(dtepisode, format = "%Y-%m-%d")) %/% months(1))

#Calculate age based on DOB for consistency
covid_data_clean <- covid_data_clean %>% 
  mutate(age_hand = as.numeric(floor(lubridate::time_length(difftime(dtepisode, dob), "years"))))
breaks <- c(0, 12, 18, 50, 65, Inf)
covid_data_clean <- covid_data_clean %>% 
  mutate(age_hand_cut = cut(age_hand, breaks=breaks, right = FALSE))

#Only keep cases with age data
covid_data_clean <- covid_data_clean %>% filter(age_hand >= 0)

hospitalizations_and_deaths <- covid_data_clean %>% filter(hospitalized=="Y" | died=="Y")
knitr::kable(head(hospitalizations_and_deaths %>% select(dob, age_hand_cut, dtepisode, dtdeath, weeks_since_Jan2020, cste_def, hospitalized, died, icu)))
```

### Aggregate cases, deaths and hospitalizations by week 
Notes:  
1. deaths and hospitalizations (num_died and num_hosp columns) reflect week of case reporting, not week of death or hospitalizations (i.e out of 110 cases in the week of January 1, 2020, 5 patients later passed away and 5 were later hospitalized)
2. weeks of death and estimated week of hospitalization are in the died and hosp columns  
3. week of death calculated using date of death 
  i. if date of death came before date of episode (n=5 deaths), used date of episode for consistency to calculate week of death  
  ii. if date of death missing, but indicator confirms death (n=270), used date of episode to calculate week of death  
4. week of hospitalization approximated as 1 week after case identification, unless patient passed away the same week case was identified 

```{r, echo=F, message=F}
hospitalizations_and_deaths <- hospitalizations_and_deaths %>% 
  mutate(weeks_death = round(as.vector(difftime(dtdeath, jan_1, units = "weeks"))), 
         weeks_death = ifelse(is.na(dtdeath),
                              round(as.vector(difftime(dtepisode, jan_1, units = "weeks"))), 
                              weeks_death), 
         weeks_death = ifelse(dtepisode>dtdeath, weeks_since_Jan2020, weeks_death)) %>%
  mutate(weeks_hosp = ifelse((weeks_death-weeks_since_Jan2020)==0, weeks_death, weeks_since_Jan2020+1), 
         weeks_hosp = ifelse(is.na(weeks_hosp)&hospitalized=="Y", weeks_since_Jan2020 + 1, weeks_hosp))

hosp_summary <- hospitalizations_and_deaths %>% filter(hospitalized=="Y") %>% 
  group_by(weeks_hosp) %>% summarise(hosp=n()) %>% rename("weeks"="weeks_hosp")
hosp_summary_age <- hospitalizations_and_deaths %>% filter(hospitalized=="Y") %>% 
  group_by(weeks_hosp, age_hand_cut) %>% summarise(hosp=n()) %>% rename("weeks"="weeks_hosp")

died_summary <- hospitalizations_and_deaths %>% filter(died=="Y") %>% 
  group_by(weeks_death) %>% summarise(died=n()) %>% rename("weeks"="weeks_death")
died_summary_age <- hospitalizations_and_deaths %>% filter(died=="Y") %>% 
  group_by(weeks_death, age_hand_cut) %>% summarise(died=n()) %>% rename("weeks"="weeks_death")

hosp_died_summary <- full_join(hosp_summary, died_summary, by="weeks") 
hosp_died_summary_age <- full_join(hosp_summary_age, died_summary_age, by=c("weeks", "age_hand_cut")) 

summary_data <- covid_data_clean %>% group_by(weeks_since_Jan2020) %>% 
  summarise(cases=n(), 
            num_died_nohosp = sum(died=="Y"&hospitalized!="Y"&icu!="Y", na.rm=T),
            # died_hosp = sum(hospitalized=="Y"&died=="Y", na.rm=T), 
            # died_icu = sum(icu=="Y"&died=="Y", na.rm=T),
            # died_hosp_icu = sum(hospitalized=="Y"&died=="Y"&icu=="Y", na.rm=T),
            num_died=sum(died=="Y", na.rm=T), num_hosp=sum(hospitalized=="Y", na.rm=T)) %>% 
  left_join(hosp_died_summary, by=c("weeks_since_Jan2020"="weeks")) %>% replace_na(list(died=0, hosp=0))

summary_data %>% head() %>% kable()

summary_data_age <- covid_data_clean %>% group_by(weeks_since_Jan2020, age_hand_cut) %>% 
  summarise(months_since_Jan2020 = round(mean(months_since_Jan2020)),
            cases=n(), 
            num_died_nohosp = sum(died=="Y"&hospitalized!="Y"&icu!="Y", na.rm=T),
            # died_hosp = sum(hospitalized=="Y"&died=="Y", na.rm=T), 
            # died_icu = sum(icu=="Y"&died=="Y", na.rm=T),
            # died_hosp_icu = sum(hospitalized=="Y"&died=="Y"&icu=="Y", na.rm=T),
            num_died=sum(died=="Y", na.rm=T), num_hosp=sum(hospitalized=="Y", na.rm=T)) %>% 
  left_join(hosp_died_summary_age, by=c("weeks_since_Jan2020"="weeks", "age_hand_cut")) %>% 
  replace_na(list(died=0, hosp=0))

summary_data_age %>% head() %>% kable()
```
### Plot absolute weekly cases, hospitalizations, and deaths over time by age group
Dates reflect week of episode, hospitalization and death respectively
```{r, echo=F}
theme_set(theme(axis.text.x = element_text(angle=90), 
    axis.line = element_line(colour = "black"),
    panel.grid.minor = element_blank(), legend.title=element_blank()))

summary_data_age %>% 
  ggplot(aes(weeks_since_Jan2020, cases, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
  ylab("Weekly cases") 
  

summary_data_age %>% 
  ggplot(aes(weeks_since_Jan2020, died, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
  ylab("Weekly deaths") 

summary_data_age %>% 
  ggplot(aes(weeks_since_Jan2020, hosp, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
  ylab("Weekly hospitalizations") 
```

```{r, include=F}
# for (group in summary_data_age$age_hand_cut) {
#   subset <- summary_data_age %>% filter(age_hand_cut==group)
#   scalar <- max(subset$cases)/max(subset$hosp)
#   p1 <- ggplot(subset, aes(weeks_since_Jan2020)) +
#     geom_line(aes(y=cases)) +
#     ggtitle(group) +
#     scale_y_continuous(name="Cases") +
#     scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month)
#   p2 <- ggplot(subset, aes(weeks_since_Jan2020)) +
#     geom_line(aes(y=hosp)) +
#     scale_y_continuous(name="Hospitalizations") +
#     scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month)
#   p3 <- ggplot(subset, aes(weeks_since_Jan2020)) +
#     geom_line(aes(y=died)) +
#     scale_y_continuous(name="Deaths") +
#     scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month)
#   print(p1+p2+p3)
# }
```

### Plot hospitalization rate and case fatality rate over time
In a given week, hospitalization rate and case fatality rate calculated as number of cases that end up being hospitalized (or number of deaths) divided by total number of cases (i.e. empirical probability that you would have been hospitalized or died due to COVID-19 in a given week)
```{r, fig.height=5, fig.width=10}
summary_data_age_month <- summary_data_age %>% group_by(months_since_Jan2020, age_hand_cut) %>%
  summarise_all(sum) %>% select(!weeks_since_Jan2020)
summary_data_age_month <- summary_data_age_month %>% mutate(hosp_rate = num_hosp/cases*100, 
                                                death_rate = num_died/cases*100)
august_rates <- summary_data_age_month %>% filter(months_since_Jan2020 == 19)
summary_data_age_month_extended <- summary_data_age_month %>% group_by(months_since_Jan2020) %>% 
  mutate(hosp_rate = ifelse(months_since_Jan2020 >= 19, august_rates$hosp_rate, hosp_rate), 
         death_rate = ifelse(months_since_Jan2020 >= 19, august_rates$death_rate, death_rate))

summary_data_age <- summary_data_age %>% mutate(hosp_rate = num_hosp/cases*100, 
                                                death_rate = num_died/cases*100)


august_rates <- summary_data_age %>% filter(months_since_Jan2020 == 19) %>% 
  group_by(age_hand_cut) %>% summarise(hosp_rate=mean(hosp_rate), death_rate=mean(death_rate))
summary_data_age_extended <- summary_data_age %>% group_by(months_since_Jan2020) %>% 
  mutate(hosp_rate = ifelse(months_since_Jan2020 > 19, august_rates$hosp_rate, hosp_rate), 
         death_rate = ifelse(months_since_Jan2020 > 19, august_rates$death_rate, death_rate)) %>% ungroup()


(summary_data_age_extended %>% filter(weeks_since_Jan2020 >= 48) %>% 
  ggplot(aes(weeks_since_Jan2020, hosp_rate, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
  scale_color_discrete(labels=c("<12", "12-17", "18-49", "50-64", "65+")) +
  ylab("Weekly hospitalization probability (%)") + ylim(0,35) + labs(color="Age group (years)") + theme(legend.title = element_text("Age group (years)")) + labs(title="A") +


summary_data_age_extended %>% filter(weeks_since_Jan2020 >= 48) %>% 
  ggplot(aes(weeks_since_Jan2020, death_rate, group=age_hand_cut, color=age_hand_cut, labels=c(""))) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
  scale_color_discrete(labels=c("<12", "12-17", "18-49", "50-64", "65+")) +
  ylab("Weekly case fatality rate (%)") + ylim(0,35)+ labs(color="Age group (years)") + 
  theme(legend.title = element_text("Age group (years)")) +  labs(title="B") +
  plot_layout(guides = "collect", nrow=1) & theme(legend.position = "bottom")) %>%
  ggsave(filename = "/mnt/projects/covid_partners/ucsf_lo/Direct Effects Analysis/final plots/hosp_death_rates.jpg", dpi=300, width=8, height=5)


p1 <- summary_data_age_month_extended %>% filter(months_since_Jan2020 >= 11) %>% 
  ggplot(aes(months_since_Jan2020, hosp_rate, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=0:21, labels=dates$month) +
  scale_color_discrete(labels=c("<12", "12-17", "18-49", "50-64", "65+")) +
  ylab("Monthly hospitalization risk (%)") + ylim(0,30) + labs(color="Age group (years)") +
  theme(legend.title = element_text("Age group (years)"))

p2 <- summary_data_age_month_extended %>% filter(months_since_Jan2020 >= 11) %>% 
  ggplot(aes(months_since_Jan2020, death_rate, group=age_hand_cut, color=age_hand_cut)) + 
  geom_line() +
  scale_x_continuous(name = "Month", breaks=0:21, labels=dates$month) +
  scale_color_discrete(labels=c("<12", "12-17", "18-49", "50-64", "65+")) +
  ylab("Monthly case fatality risk (%)") + ylim(0,30) + labs(color="Age group (years)") +
  theme(legend.title = element_text("Age group (years)"))


(p1+p2 +  plot_layout(guides = "collect", nrow=1) & theme(legend.position = "bottom")) %>% ggsave(filename = "/mnt/projects/covid_partners/ucsf_lo/Direct Effects Analysis/final plots/hosp_death_rates_month.jpg", dpi=300, width=8, height=5)


saveRDS(summary_data_age_extended, "Direct Effects Analysis/Hospitalizations and deaths/hosp_rate_weekly.RDS")
saveRDS(summary_data_age_month_extended, "Direct Effects Analysis/Hospitalizations and deaths/hosp_rate_monthly.RDS")
```

### Use averted cases and rate of hospitalization and death over time to predict averted hospitalizations and deaths
Note: Using this approach since using same methodology for cases with hospitalizations and deaths isn't well powered (few hospitalizations and deaths in unvaccinated population)
```{r}
primary_cases <- readRDS("primary_res_bounded.RDS")

summary_data_age_vacc <- summary_data_age_extended %>%
  left_join(summary_data_age_month_extended %>% select(months_since_Jan2020, age_hand_cut, hosp_rate, death_rate),
            c("months_since_Jan2020", "age_hand_cut")) %>%
  select(!c(hosp_rate.x, death_rate.x)) %>% rename("hosp_rate"="hosp_rate.y", "death_rate"="death_rate.y")

saveRDS(summary_data_age_vacc, "hosp_rate_week_month_rates.RDS")

summary_data_age_vacc <- filter(summary_data_age_vacc, weeks_since_Jan2020 >= 48)

total_res_hosp <- NULL
tbl_hosp <- NULL
red_hosp <- NULL

total_res_death <- NULL
tbl_death <- NULL
red_death <- NULL

prep_res <- function(data, age) {
  res <- data[,2:4]-data[,1]
  
  res <- as.data.frame(cbind(res, data))
  names(res) <- c("pred_averted", "lb_averted", "ub_averted",
                  "actual_hosp", "pred_hosp", "lb_hosp", "ub_hosp")

  res$weeks_since_Jan2020 <- 48:93
  res$age <- age
  
  res <- res %>% mutate(pred_averted = ifelse(pred_averted < 0, 0, pred_averted),
                        lb_averted = ifelse(lb_averted < 0, 0, lb_averted),
                        ub_averted = ifelse(ub_averted < 0, 0, ub_averted),
                        pred_hosp = ifelse(pred_hosp < actual_hosp, actual_hosp, pred_hosp),
                        lb_hosp = ifelse(lb_hosp < actual_hosp, actual_hosp, lb_hosp),
                        ub_hosp = ifelse(ub_hosp < actual_hosp, actual_hosp, ub_hosp))
  
  res
}

groups <- (summary_data_age_vacc$age_hand_cut %>% unique())[3:5]
for (group in 1:3) {
  subset <- summary_data_age_vacc %>% filter(age_hand_cut==groups[group])
  if (group==1){
    subset_cases <- primary_cases %>% select(pred_18_50, lb_18_50, ub_18_50)
  } else if (group==2){
    subset_cases <- primary_cases %>% select( pred_50_65, lb_50_65, ub_50_65)
  } else{
    subset_cases <- primary_cases %>% select(pred_65, lb_65, ub_65)
  }
  
  hosp <- subset_cases * subset$hosp_rate/100
  death <- subset_cases * subset$death_rate/100
  
  hosp_res <- prep_res(cbind(subset$num_hosp, hosp), groups[group])
  death_res <- prep_res(cbind(subset$num_died, death), groups[group])
  
  averted <- apply(hosp_res[,1:7], 2, sum)
  tbl_hosp <- rbind(tbl_hosp, averted[c(4, 5:7, 1:3)])
  total_res_hosp <- rbind(total_res_hosp, hosp_res)
  red_hosp <- rbind(red_hosp, averted[1:3]/apply(hosp[,1:3], 2, sum)*100)
  
  averted <- apply(death_res[,1:7], 2, sum)
  tbl_death <- rbind(tbl_death, averted[c(4, 5:7, 1:3)])
  total_res_death <- rbind(total_res_death, death_res)
  red_death <- rbind(red_death, averted[1:3]/apply(death[,1:3], 2, sum)*100)

}

saveRDS(total_res_death, "Direct Effects Analysis/final results/death_results_primary_model.RDS")
saveRDS(total_res_hosp, "Direct Effects Analysis/final results/hosp_results_primary_model.RDS")
```

```{r}
tbl_hosp <- rbind(tbl_hosp, apply(tbl_hosp, 2, sum))
tbl_death <- rbind(tbl_death, apply(tbl_death, 2, sum))

hosp <- format(round(tbl_hosp, -1), big.mark=",", trim = T)
death <- format(round(tbl_death, -1), big.mark=",", trim = T)

hosp <- as.data.frame(cbind(c(groups%>% as.character(), "Total"), hosp[,1], paste0(hosp[,2], " (", hosp[,3], ", ", hosp[,4], ")"),
                            paste0(hosp[,5], " (", hosp[,6], ", ", hosp[,7], ")")))
death <- as.data.frame(cbind(c(groups%>% as.character(), "Total"), death[,1], paste0(death[,2], " (", death[,3], ", ", death[,4], ")"),
                             paste0(death[,5], " (", death[,6], ", ", death[,7], ")")))

tbl <- rbind(hosp, death)
names(tbl) <- c("Age group", "Observed outcome", "Predicted outcome (95% UI)", "Averted outcome (95% UI)")
tbl %>% write_excel_csv("Direct Effects Analysis/Hospitalizations and deaths/hosp_death_res.xls")
tbl %>% kable()

vacc_coverage <- vacc_avg[c(2, 3, 4, 6)]
red_hosp <- rbind(red_hosp, (tbl_hosp[4,5:7]/tbl_hosp[4,2:4])*100)
red_hosp <- cbind(red_hosp, red_hosp/vacc_coverage*100)
red_hosp[red_hosp > 100] <- 100

red_death <- rbind(red_death, (tbl_death[4,5:7]/tbl_death[4,2:4])*100)
red_death <- cbind(red_death, red_death/vacc_coverage*100)
red_death[red_death > 100] <- 100

hosp <- format(round(red_hosp), big.mark=",", trim=T)
death <- format(round(red_death), big.mark=",", trim=T)
tbl <- as.data.frame(cbind(c(as.character(groups), "Total"), 
                           paste0(hosp[,4], " (", hosp[,5], ", ", hosp[,6], ")"),
                           paste0(hosp[,1], " (", hosp[,2], ", ", hosp[,3], ")"),
                           paste0(death[,4], " (", death[,5], ", ", death[,6], ")"),
                           paste0(death[,1], " (", death[,2], ", ", death[,3], ")")))
names(tbl) <- c("Age group", 
                "Adjusted reduction in hospitalizations (%) (95% PI)", 
                "Reduction in hospitalizations (%) (95% PI)", 
                "Adjusted reduction in deaths (%) (95% PI)",
                "Reduction in deaths (%) (95% PI)")
tbl %>% write_excel_csv("Direct Effects Analysis/Hospitalizations and deaths/hosp_death_red_res.xls")
tbl %>% kable()
```

```{r, fig.height=4, fig.width=9}
total_res_hosp %>% select(!age) %>% group_by(weeks_since_Jan2020) %>% summarise_all(sum)
max_val <- max(total_res_hosp$ub_hosp)
for (group in groups[2:4]) {
  subset_hosp <- total_res_hosp %>% filter(age==group) 
  if(group=="[18,50)") {
    p <-  ggplot(subset_hosp, aes(weeks_offset, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted hospitalizations")) +
    geom_line(aes(y=actual_hosp, color="Observed hospitalizations")) + 
    ggtitle(group) + 
    ylab("Hospitalizations") + 
    scale_y_continuous(labels=comma, limits = c(0, max_val)) +
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month)
  } else {
    p <- p + ggplot(subset_hosp, aes(weeks_offset, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted hospitalizations")) +
    geom_line(aes(y=actual_hosp, color="Observed hospitalizations")) + 
    ggtitle(group) + ylab(element_blank()) + 
    scale_y_continuous(labels=comma, limits = c(0, max_val)) +
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) #+ 
    #theme(axis.text=element_blank())
  }
}
(p + plot_layout(guides = "collect", nrow=1) & theme(legend.position = "bottom")) 

hosp <- total_res_hosp %>% filter(age!="[12,18)") %>% select(!age) %>% group_by(weeks_since_Jan2020) %>% summarise_all(sum) %>% 
  mutate(vacc_cum = primary_cases$vacc_cum_18up)
scalar2 <- max(hosp$ub_hosp)/100
plot2 <- hosp %>%
    ggplot(aes(weeks_since_Jan2020, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted outcome")) + geom_line(aes(y=actual_hosp, color="Observed outcome")) + 
    geom_line(aes(y=vacc_cum*scalar2, color="Cumulative vaccination (%)")) +
    scale_y_continuous(labels=comma, 
                       expand = expansion(mult=c(0, 0.05)), 
                       sec.axis = sec_axis(~./scalar2, breaks=seq(0,100,25))) + 
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
    geom_vline(aes(xintercept=74), linetype="dashed") +
    labs(title="B", subtitle = "Hospitalizations") + 
    theme(legend.title=element_blank(), axis.text.x = element_text(angle=90), 
          axis.line = element_line(colour = "black"),
          panel.grid.minor = element_blank(), plot.subtitle = element_text(hjust = 0), 
          axis.title.y.left = element_blank())
plot2
```

```{r, fig.height=4, fig.width=9}
max_val <- max(total_res_death$ub_hosp)
for (group in groups[2:4]) {
  subset_hosp <- total_res_death %>% filter(age==group) 
  if(group=="[18,50)") {
    p <-  ggplot(subset_hosp, aes(weeks_offset, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted deaths")) +
    geom_line(aes(y=actual_hosp, color="Observed deaths")) + 
    ggtitle(group) + 
    ylab("Deaths") +
    scale_y_continuous(labels=comma, limits = c(0, max_val)) +
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month)
  } else {
    p <- p + ggplot(subset_hosp, aes(weeks_offset, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted deaths")) +
    geom_line(aes(y=actual_hosp, color="Observed deaths")) + 
    ggtitle(group) + ylab(element_blank()) +    
    scale_y_continuous(labels=comma, limits = c(0, max_val)) +
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) 
  }
}
(p + plot_layout(guides = "collect", nrow=1) & theme(legend.position = "bottom")) 
death <- total_res_death %>% filter(age!="[12,18)") %>% select(!age) %>% group_by(weeks_since_Jan2020) %>% summarise_all(sum) %>% 
  mutate(vacc_cum = primary_cases$vacc_cum_18up)
scalar3 <- scalar <- max(death$ub_hosp)/100
plot3 <- death %>%
    ggplot(aes(weeks_since_Jan2020, pred_hosp)) +
    geom_ribbon(aes(ymax=ub_hosp, ymin=lb_hosp), fill="grey80") +
    geom_line(aes(color="Predicted outcome")) + geom_line(aes(y=actual_hosp, color="Observed outcome")) + 
    geom_line(aes(y=vacc_cum*scalar3, color="Cumulative vaccination (%)")) +
    scale_y_continuous(labels=comma, 
                       expand = expansion(mult=c(0, 0.05)), 
                       sec.axis = sec_axis(~./scalar3, breaks=seq(0,100,25), name="Cumulative vaccine coverage (%)")) + 
    geom_vline(aes(xintercept=74), linetype="dashed") +
    labs(title="C", subtitle = "Deaths") + 
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
    theme(legend.title=element_blank(), axis.text.x = element_text(angle=90), 
          axis.line = element_line(colour = "black"),
          panel.grid.minor = element_blank(), plot.subtitle = element_text(hjust=0),
          axis.title.y.left = element_blank())
plot3
```

```{r}
scalar1 <- max(primary_cases$total_cases_ub)/100
plot1 <- primary_cases %>% 
    ggplot(aes(x=weeks_since_Jan2020)) + 
    geom_ribbon(aes(ymax=total_cases_ub, ymin=total_cases_lb), fill="grey80") +
    geom_line(aes(y=total_cases, color="Observed outcome")) + 
    geom_line(aes(y=total_cases_pred, color="Predicted outcome")) + 
    geom_line(aes(y=vacc_cum*scalar1, color="Cumulative vaccination (%)")) +
    scale_y_continuous(name="Weekly outcome", labels=comma, 
                       expand = expansion(mult=c(0, 0.05)), 
                       sec.axis = sec_axis(~./scalar1, breaks=seq(0,100,25))) + 
    geom_vline(aes(xintercept=74), linetype="dashed") +
    scale_x_continuous(name = "Month", breaks=dates$weeks, labels=dates$month) +
    labs(title="A", subtitle = "Cases") + 
    theme(legend.title=element_blank(), axis.text.x = element_text(angle=90), 
          axis.line = element_line(colour = "black"),
          panel.grid.minor = element_blank(), plot.subtitle = element_text(hjust=0))
plot1
```


```{r, fig.width=9.5, fig.height=4}
library(devEMF)
emf(file="/mnt/projects/covid_partners/ucsf_lo/Direct Effects Analysis/final plots/all_primary_model_results.emf", width = 10, height=4)
print((plot1+plot2+plot3+#plot_annotation("Averted COVID-19 cases, hospitalizations, and deaths due to COVID-19 vaccination in California", ) + 
  plot_layout(guides = "collect", nrow=1) & theme(legend.position = "bottom"))) #%>% 
  # ggsave(filename="/mnt/projects/covid_partners/ucsf_lo/Direct Effects Analysis/final plots/all_primary_model_results.emf", width = 10, height=4, device = "emf")
  #, plot.title = element_text(hjust = 0.5))
dev.off()
```


```{r}
hosp <- hosp %>% mutate(red = pred_averted/pred_hosp*100/vacc_cum, 
                      red_lb = lb_averted/lb_hosp*100/vacc_cum, 
                      red_ub = ub_averted/ub_hosp*100/vacc_cum, 
                      red = ifelse(red>1, 100, red*100), 
                      red_lb = ifelse(red_lb>1, 100, red_lb*100),
                      red_ub = ifelse(red_ub>1, 100, red_ub*100))

death <- death %>% mutate(red = pred_averted/pred_hosp*100/vacc_cum, 
                      red_lb = lb_averted/lb_hosp*100/vacc_cum, 
                      red_ub = ub_averted/ub_hosp*100/vacc_cum, 
                      red = ifelse(red>1, 100, red*100), 
                      red_lb = ifelse(red_lb>1, 100, red_lb*100),
                      red_ub = ifelse(red_ub>1, 100, red_ub*100))

cases <- primary_cases %>% mutate(red = (total_cases_pred-total_cases)/total_cases_pred*100/vacc_cum, 
                      red_lb = (total_cases_lb-total_cases)/total_cases_lb*100/vacc_cum, 
                      red_ub = (total_cases_ub-total_cases)/total_cases_ub*100/vacc_cum, 
                      red = ifelse(red>1, 100, red*100), 
                      red_lb = ifelse(red_lb>1, 100, red_lb*100),
                      red_ub = ifelse(red_ub>1, 100, red_ub*100))

p1 <- cases %>% ggplot(aes(weeks_since_Jan2020)) + 
  geom_ribbon(aes(ymax=red_ub, ymin=red_lb), fill="grey80") +
  geom_line(aes(y=red)) + 
  geom_vline(aes(xintercept=74), linetype="dashed") +
  scale_x_continuous(name = element_blank(), breaks=dates$weeks, labels=dates$month) +
  labs(title="A", subtitle = "Cases") + ylab("Adjusted relative reduction (%)") + theme(axis.text.x = element_text(angle=90))
p2 <- hosp %>% ggplot(aes(weeks_since_Jan2020)) + 
  geom_ribbon(aes(ymax=red_ub, ymin=red_lb), fill="grey80") +
  geom_line(aes(y=red)) + 
  geom_vline(aes(xintercept=74), linetype="dashed") +
  scale_x_continuous(name = element_blank(), breaks=dates$weeks, labels=dates$month) +
  labs(title="B", subtitle = "Hospitalizations") + ylab("Adjusted relative reduction (%)") + theme(axis.text.x = element_text(angle=90))
p3 <- death %>% ggplot(aes(weeks_since_Jan2020)) + 
  geom_ribbon(aes(ymax=red_ub, ymin=red_lb), fill="grey80") +
  geom_line(aes(y=red)) + 
  geom_vline(aes(xintercept=74), linetype="dashed") +
  scale_x_continuous(name = "Month\n\nPrimary model", breaks=dates$weeks, labels=dates$month) +
  labs(title="C", subtitle = "Deaths") + ylab("Adjusted relative reduction (%)") + theme(axis.text.x = element_text(angle=90))

reduction_primary <- p1+p2+p3+plot_layout(ncol=1)
   
```


